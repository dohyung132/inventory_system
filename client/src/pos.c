#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "pos.h"
#include "ui.h"
#include "network.h"
#include "utils.h"

#define MAX_CART 100

// =====================================================================
// [ë°ì´í„° êµ¬ì¡°: Client-Side Inventory State]
// ì„œë²„ DBì˜ ìµœì¢… ë°˜ì˜ ì „, ë‹¨ë§ê¸° ë©”ëª¨ë¦¬ì—ë§Œ ì¡´ì¬í•˜ëŠ” ì„ì‹œ ìƒíƒœì…ë‹ˆë‹¤.
// ë„¤íŠ¸ì›Œí¬ ë¹„ìš© ìµœì í™”ë¥¼ ìœ„í•´ ë¡œì»¬ì—ì„œ ë¨¼ì € ê²€ì¦ í›„ ì¼ê´„ ê²°ì œ ë°©ì‹ì„ ì·¨í•©ë‹ˆë‹¤.
// =====================================================================
static CartItem cart[MAX_CART];
static int cart_count = 0;

void init_pos_system(void) { 
    cart_count = 0; 
}

void show_cart(void) {
    printf(" ğŸ›’ [í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ]\n");
    if (cart_count == 0) { 
        printf("  - ë¹„ì–´ ìˆìŒ -\n"); 
        return; 
    }
    for (int i = 0; i < cart_count; i++) {
        printf("  %d. %-15s : %dê°œ\n", i + 1, cart[i].name, cart[i].qty);
    }
}

void clear_cart(void) {
    cart_count = 0;
    print_system_message("[ì•ˆë‚´] ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.");
}

/**
 * @brief ì„œë²„ ì¬ê³  í™•ì¸ ë° ë¡œì»¬ ì¥ë°”êµ¬ë‹ˆ ì—…ë°ì´íŠ¸
 * [ë‹¨ê³„ 1] ë¡œì»¬ ìƒíƒœ(Cart Full ì—¬ë¶€) ë° ì…ë ¥ê°’ ìœ íš¨ì„± ì„ í–‰ ê²€ì¦
 * [ë‹¨ê³„ 2] ì„œë²„ í†µì‹ (cmd 17)ì„ í†µí•œ DBìƒì˜ ì‹¤ì¬ê³  ê°€ìš©ì„± í™•ì¸
 * [ë‹¨ê³„ 3] ì„œë²„ ìŠ¹ì¸(OK) ì‹œ ë¡œì»¬ ë°°ì—´ì— ë°ì´í„° ë³‘í•© ë˜ëŠ” ì‹ ê·œ í• ë‹¹
 * * @return int í†µì‹  ì„±ê³µ ë° ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ ì‹œ 0, ì„œë²„ ë‹¨ì ˆ ì‹œ -1
 */
static int add_to_cart(int sock, uint32_t cid, const char* name, int qty) {
    // [ì˜ˆì™¸ ì¼€ì´ìŠ¤] ë°°ì—´ ì¸ë±ìŠ¤ ì´ˆê³¼ ë°©ì§€ (Memory Safety)
    if (cart_count >= MAX_CART) { 
        print_system_message("[ì‹¤íŒ¨] ì¥ë°”êµ¬ë‹ˆê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); 
        return 0; 
    }
    
    // [ìœ íš¨ì„± ê²€ì‚¬] ë…¼ë¦¬ì  ì˜¤ë¥˜ ë°ì´í„°(0 ë˜ëŠ” ìŒìˆ˜) ìœ ì… ì°¨ë‹¨
    if (qty <= 0) { 
        print_system_message("[ì‹¤íŒ¨] ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); 
        return 0; 
    }

    char payload[256], res_msg[MAX_PAYLOAD];
    
    /* * [ë²„í¼ ì•ˆì „ì„± í™•ë³´] 
     * snprintf()ëŠ” ë„ ë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ ì§€ì •ëœ í¬ê¸°ë§Œí¼ë§Œ ê¸°ë¡í•˜ë¯€ë¡œ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
     * %.49sëŠ” ì…ë ¥ ì†ŒìŠ¤(name)ê°€ ì•„ë¬´ë¦¬ ê¸¸ì–´ë„ ìµœëŒ€ 49ìë§Œ ë³µì‚¬í•˜ë„ë¡ ê°•ì œí•©ë‹ˆë‹¤.
     */
    snprintf(payload, sizeof(payload), "%.49s|%d", name, qty);
    
    // [ì„œë²„ í†µì‹ ] ì‹¤ì‹œê°„ ì¬ê³  ê°€ìš©ì„± ì¿¼ë¦¬ ì „ì†¡
    if (send_and_receive(sock, cid, 17, payload, res_msg, NULL) < 0) return -1;

    // [ë°ì´í„° ì²˜ë¦¬] ì„œë²„ ì‘ë‹µ ë¶„ì„ í›„ ë¡œì»¬ ìƒíƒœ ë™ê¸°í™”
    if (strncmp(res_msg, "OK", 2) == 0) {
        for (int i = 0; i < cart_count; i++) {
            if (strcmp(cart[i].name, name) == 0) {
                cart[i].qty += qty; // ê¸°ì¡´ í’ˆëª© ì¡´ì¬ ì‹œ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
                printf("\n[ì•ˆë‚´] '%s' ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ë¨. (í˜„ì¬ %dê°œ)\n", name, cart[i].qty);
                return 0;
            }
        }
        // ì‹ ê·œ í’ˆëª© ì¶”ê°€ ì‹œ ë¬¸ìì—´ ì•ˆì „ ë³µì‚¬(strncpy) ë° ë„ ì¢…ë£Œ ë³´ì¥
        strncpy(cart[cart_count].name, name, 49); 
        cart[cart_count].name[49] = '\0';
        cart[cart_count].qty = qty; 
        cart_count++;
        printf("\n[ì•ˆë‚´] '%s' ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ë¨.\n", name);
    } else {
        print_system_message(res_msg); // ì„œë²„ ì¸¡ ê±°ì ˆ ì‚¬ìœ (ì˜ˆ: ì¬ê³  ë¶€ì¡±) ì‚¬ìš©ì ì•Œë¦¼
    }
    return 0;
}

/**
 * @brief ê²°ì œ ì²˜ë¦¬ ë° íŠ¸ëœì­ì…˜ ì˜ˆì™¸ ëŒ€ì‘
 * [ê°œì„  ì‚¬í•­] í˜„ì¬ëŠ” ê° ì•„ì´í…œë³„ë¡œ ê°œë³„ ìš”ì²­ì„ ë³´ë‚´ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤. 
 * í–¥í›„ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œ ì¼ë¶€ë§Œ ê²°ì œë˜ëŠ” 'Partial Success' ë¬¸ì œë¥¼ ë§‰ê¸° ìœ„í•´ 
 * ì„œë²„ì¸¡ì—ì„œ ì¼ê´„ ì²˜ë¦¬(All-or-Nothing)ë¥¼ ì§€ì›í•˜ëŠ” ì›ìì (Atomic) íŒ¨í‚· êµ¬ì¡° ë„ì…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
 * * @return int ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì •ìƒ ì™„ë£Œ ì‹œ 0, ì¤‘ê°„ ë‹¨ì ˆ ì‹œ -1
 */
static int process_checkout(int sock, uint32_t cid) {
    if (cart_count == 0) { 
        print_system_message("[ì•ˆë‚´] ê²°ì œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤."); 
        return 0; 
    }

    printf("\n=== ê²°ì œ ì§„í–‰ ===\n");
    char payload[256], res_msg[MAX_PAYLOAD];
    
    // [íŠ¸ëœì­ì…˜ ë¦¬ìŠ¤í¬] í†µì‹  ì¥ì•  ì‹œ ë£¨í”„ê°€ ì¤‘ë‹¨ë˜ë©°, ì´ë•Œê¹Œì§€ ì „ì†¡ëœ ê±´ë§Œ ì„œë²„ DBì— ë°˜ì˜ë¨
    for (int i = 0; i < cart_count; i++) {
        snprintf(payload, sizeof(payload), "%s|%d", cart[i].name, cart[i].qty);
        if (send_and_receive(sock, cid, 14, payload, res_msg, NULL) < 0) {
            // ê²°ì œ ì‹¤íŒ¨ ì‹œ í›„ì† ì²˜ë¦¬: ë‚¨ì€ ì¥ë°”êµ¬ë‹ˆ ìœ ì§€ ë° ìƒìœ„ ì¬ì—°ê²° ë¡œì§ìœ¼ë¡œ ì œì–´ê¶Œ ìœ„ì„
            return -1; 
        }
        printf("%s\n", res_msg); 
    }
    
    // [í™•ì •] ëª¨ë“  ì„œë²„ ì‘ë‹µì´ ìˆ˜ì‹ ëœ ê²½ìš°ì—ë§Œ ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
    cart_count = 0;
    print_system_message("[ì•ˆë‚´] ê²°ì œê°€ ì™„ë£Œë˜ì–´ ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤.");
    return 0;
}

/**
 * @brief POS ë©”ì¸ ì œì–´ ë£¨í”„ ë° I/O Multiplexing ê´€ë¦¬
 * [I/O ì „ëµ] select() í•¨ìˆ˜ë¥¼ í†µí•œ ë™ê¸°ì‹ ë¹„ì°¨ë‹¨(Synchronous Non-blocking) ê°ì‹œ ì ìš©.
 * ì‚¬ìš©ìê°€ í‚¤ë³´ë“œë¥¼ ì…ë ¥í•˜ì§€ ì•Šë”ë¼ë„ ì„œë²„ ì†Œì¼“ì˜ EOF(ì—°ê²° ì¢…ë£Œ) ì´ë²¤íŠ¸ë¥¼ 
 * ì¦‰ê° ê°ì§€í•˜ì—¬, "ê°‡í˜ í˜„ìƒ" ì—†ì´ ì¬ì—°ê²° í™”ë©´ìœ¼ë¡œ ì¦‰ì‹œ ì „í™˜í•©ë‹ˆë‹¤.
 */
int run_pos_mode(int sock, uint32_t cid) {
    char res_msg[MAX_PAYLOAD], input_buf[100];
    
    while (1) {
        // [Data Sync] í™”ë©´ ê°±ì‹  ì „ ì„œë²„ë¡œë¶€í„° ìµœì‹  íŒë§¤ í’ˆëª© ë¦¬ìŠ¤íŠ¸ ìˆ˜ì‹ 
        if (send_and_receive(sock, cid, 15, "", res_msg, NULL) < 0) return -1;

        // [View] ë©”ë‰´íŒê³¼ í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ í†µí•© ë Œë”ë§
        clear_screen();
        printf("======================================\n");
        printf("   [íŒë§¤ ëª¨ë“œ í†µí•© ë‹¨ë§ê¸°] POS-%04d\n", cid);
        printf("======================================\n");
        printf("%s", res_msg);
        printf("--------------------------------------\n");
        show_cart();
        printf("======================================\n");
        printf(" ğŸ‘‰ ì¶”ê°€: [ìƒí’ˆëª…] [ìˆ˜ëŸ‰] (ì˜ˆ: ì½œë¼ 2)\n");
        printf(" ğŸ‘‰ ëª…ë ¹: [ê²°ì œ: pay] [ë¹„ìš°ê¸°: clear] [ë‚˜ê°€ê¸°: 0]\n");
        
        // [I/O ê°ì‹œ] í‚¤ë³´ë“œ ì…ë ¥(stdin)ê³¼ ì„œë²„ ì†Œì¼“(sock)ì„ ë™ì‹œì— ëª¨ë‹ˆí„°ë§
        // ì„œë²„ê°€ ì˜ˆê¸°ì¹˜ ì•Šê²Œ ì¢…ë£Œë˜ë©´ select()ê°€ ë°˜ì‘í•˜ì—¬ ì¦‰ì‹œ -1 ë°˜í™˜
        if (get_string_input(sock, " >> ", input_buf, sizeof(input_buf)) < 0) return -1;

        // [Logic Dispatch] ì…ë ¥ ëª…ë ¹ì–´ ë¶„ì„ ë° ê¸°ëŠ¥ ë¶„ê¸°
        if (strcmp(input_buf, "0") == 0) {
            break; // ìƒìœ„ ë©”ì¸ ë©”ë‰´ë¡œ ì•ˆì „í•œ ì œì–´ê¶Œ ë°˜í™˜
        } 
        else if (strcmp(input_buf, "pay") == 0) { 
            if (process_checkout(sock, cid) < 0) return -1; 
            if (pause_screen(sock) < 0) return -1; 
        } 
        else if (strcmp(input_buf, "clear") == 0) { 
            clear_cart(); 
            if (pause_screen(sock) < 0) return -1; 
        } 
        else {
            char name[50]; 
            int qty = 0;
            // %49s í¬ë§· ì§€ì‹œìë¥¼ ì‚¬ìš©í•˜ì—¬ 50ë°”ì´íŠ¸ ë°°ì—´(name)ì˜ ê²½ê³„ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ì•ˆì „í•˜ê²Œ íŒŒì‹±
            if (sscanf(input_buf, "%49s %d", name, &qty) == 2) { 
                if (add_to_cart(sock, cid, name, qty) < 0) return -1; 
                if (pause_screen(sock) < 0) return -1; 
            }
            else { 
                print_system_message("[ì˜¤ë¥˜] ì…ë ¥ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); 
                if (pause_screen(sock) < 0) return -1; 
            }
        }
    }
    return 0;
}

/**
 * @brief íŠ¹ì • ìƒí’ˆì˜ ìƒì„¸ ëª©ë¡ ì¡°íšŒ ë° ê°œë³„/ì¼ê´„ ì‚­ì œ ê´€ë¦¬
 * [ë‹¨ê³„ 1] ì„œë²„ì— ìƒí’ˆëª…ê³¼ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì „ë‹¬í•˜ì—¬ ìƒì„¸ ë°ì´í„° ìš”ì²­ (Paging)
 * [ë‹¨ê³„ 2] ìˆ˜ì‹ ëœ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ê³  ì‚¬ìš©ì ì‘ì—…(ì´ë™/ì‚­ì œ/ë³µê·€) ëŒ€ê¸°
 * [ë‹¨ê³„ 3] ì…ë ¥ê°’ ë¶„ì„: ìˆ«ì(í˜ì´ì§€ ì´ë™), 'all'(ì¼ê´„ ì‚­ì œ), ë¬¸ìì—´(ë‹¨ì¼ ID ì‚­ì œ)
 * * @param sock ì†Œì¼“ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° (ì„œë²„ í†µì‹  ë° ìƒíƒœ ê°ì‹œìš©)
 * @param cid ë‹¨ë§ê¸° ê³ ìœ  ID
 * @param is_expired_mode ì¡°íšŒ ëª¨ë“œ ì„¤ì • (0: ì „ì²´ ì¬ê³ , 1: ë§Œë£Œ ì¬ê³ )
 * @param name ìƒì„¸ ì¡°íšŒí•  ëŒ€ìƒ ìƒí’ˆëª… (ì˜ˆ: "ê¹€ë°¥")
 * @return int ì„±ê³µ ì‹œ 0, í†µì‹  ë‹¨ì ˆ ì‹œ -1 (ì—ëŸ¬ ìºìŠ¤ì¼€ì´ë”©)
 */
static int manage_inventory_detail(int sock, uint32_t cid, int is_expired_mode, const char* name) {
    char payload[256], res_msg[MAX_PAYLOAD], action[50];
    // ëª¨ë“œì— ë”°ë¥¸ ëª…ë ¹ì–´ ë¶„ê¸°: ì „ì²´ ìƒì„¸(9) ë˜ëŠ” ë§Œë£Œ ìƒì„¸(11)
    int detail_cmd = is_expired_mode ? 11 : 9;
    int page = 1;

    while (1) {
        // [ë°ì´í„° íŒ¨í‚¤ì§•] snprintfë¥¼ ì‚¬ìš©í•´ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°©ì§€í•˜ë©° ì¡°íšŒ íŒŒë¼ë¯¸í„° êµ¬ì„±
        snprintf(payload, sizeof(payload), "%s|%d", name, page); 
        int total_pages = 1; // ì„œë²„ë¡œë¶€í„° ê°±ì‹ ë°›ì„ ì´ í˜ì´ì§€ ìˆ˜ ì €ì¥ ë³€ìˆ˜

        /* [ì„œë²„ í†µì‹  ë° ë°ì´í„° ë™ê¸°í™”]
         * ì„œë²„ëŠ” ìš”ì²­ëœ í˜ì´ì§€ì˜ ë°ì´í„°ì™€ í•¨ê»˜ í•´ë‹¹ ê²€ìƒ‰ ê²°ê³¼ì˜ ì „ì²´ í˜ì´ì§€ ìˆ˜ë¥¼ ì‘ë‹µí•©ë‹ˆë‹¤.
         * ë§Œì•½ ì„œë²„ê°€ ì‘ë‹µí•˜ì§€ ì•Šìœ¼ë©´ ì¦‰ì‹œ -1ì„ ë°˜í™˜í•˜ì—¬ ìƒìœ„ ë£¨í”„ì˜ ì¬ì—°ê²° ë¡œì§ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
         */
        if (send_and_receive(sock, cid, detail_cmd, payload, res_msg, &total_pages) < 0) return -1;

        // [í™”ë©´ ë Œë”ë§] ì´ì „ í™”ë©´ì„ ì§€ìš°ê³  ì„œë²„ì—ì„œ ìˆ˜ì‹ í•œ ìƒì„¸ ëª©ë¡(ID, ìœ í†µê¸°í•œ ë“±) ì¶œë ¥
        clear_screen();
        printf("%s\n--------------------------------------\n", res_msg);

        // [ì‚¬ìš©ì ì•ˆë‚´] í˜„ì¬ ëª¨ë“œ(ì •ìƒ/ë§Œë£Œ)ì— ìµœì í™”ëœ ê°€ì´ë“œë¼ì¸ ì¶œë ¥
        if (is_expired_mode) 
            printf(" ğŸ‘‰ [0: ë’¤ë¡œ] [í˜ì´ì§€ ë²ˆí˜¸] [ì‚­ì œí•  ID] [all: '%s' ë§Œë£Œ ì „ì²´ ì‚­ì œ]\n", name);
        else 
            printf(" ğŸ‘‰ [0: ë’¤ë¡œ] [í˜ì´ì§€ ë²ˆí˜¸] [ì‚­ì œí•  ID] [all: '%s' ì „ì²´ ì‚­ì œ]\n", name);

        /* [I/O Multiplexing ê°ì‹œ]
         * get_string_inputì€ ë‚´ë¶€ì ìœ¼ë¡œ select()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆì—ë„
         * ì„œë²„ ì†Œì¼“ì˜ ìƒíƒœë¥¼ ê°ì‹œí•©ë‹ˆë‹¤. ì…ë ¥ ë„ì¤‘ ì„œë²„ê°€ ì¢…ë£Œë˜ë©´ ì¦‰ì‹œ ì´ë¥¼ ê°ì§€í•˜ê³  -1ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        if (get_string_input(sock, " >> ", action, sizeof(action)) < 0) return -1;

        // [ëª…ë ¹ì–´ ì²˜ë¦¬ ë¶„ê¸°] 
        // 1. ìƒìœ„ ë©”ë‰´(ìš”ì•½ í™”ë©´)ë¡œ ë³µê·€
        if (strcmp(action, "0") == 0) break; 
        
        // 2. ì¹´í…Œê³ ë¦¬ ì¼ê´„ ì‚­ì œ (íŠ¸ëœì­ì…˜)
        else if (strcmp(action, "all") == 0) { 
            // ì‚­ì œ ëª¨ë“œ ì„¤ì •: ì „ì²´ ì‚­ì œ(12) ë˜ëŠ” ë§Œë£Œë¶„ë§Œ ì‚­ì œ(13)
            int del_cmd = is_expired_mode ? 13 : 12; 
            if (send_and_receive(sock, cid, del_cmd, name, res_msg, NULL) < 0) return -1;
            
            print_system_message(res_msg); 
            if (pause_screen(sock) < 0) return -1;
            break; // í•´ë‹¹ ìƒí’ˆêµ°ì´ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ìš”ì•½ í™”ë©´ìœ¼ë¡œ ì œì–´ê¶Œ ë°˜í™˜
        } 
        
        // 3. í˜ì´ì§€ ì´ë™ ë˜ëŠ” ë‹¨ì¼ ID ì‚­ì œ ì²˜ë¦¬
        else {
            int parsed_page = atoi(action); 

            // [ë°ì´í„° ìœ íš¨ì„± ê²€ì¦] 
            // - ìˆ«ìê°€ ì…ë ¥ë˜ì—ˆìœ¼ë©°, ì„œë²„ê°€ ì•Œë ¤ì¤€ ìœ íš¨ í˜ì´ì§€ ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            if (parsed_page > 0 && parsed_page <= total_pages) 
                page = parsed_page; // ì •ìƒ ë²”ìœ„ì¼ ê²½ìš° í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ ë£¨í”„ ì¬ì‹œì‘
            
            // - ì˜ëª»ëœ ë²”ìœ„ì˜ ìˆ«ì ì…ë ¥ì— ëŒ€í•œ ì˜ˆì™¸ ì²˜ë¦¬
            else if (parsed_page > total_pages || parsed_page < 0) {
                print_system_message("[ì˜¤ë¥˜] ìœ íš¨í•˜ì§€ ì•Šì€ í˜ì´ì§€ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
                if (pause_screen(sock) < 0) return -1;
            }
            
            // 4. ì…ë ¥ê°’ì´ ìˆ«ìê°€ ì•„ë‹ ê²½ìš° ìƒí’ˆ ê³ ìœ  IDë¡œ ê°„ì£¼í•˜ê³  ì‚­ì œ ì‹œë„
            else {
                /* [ë‹¨ì¼ ì‚­ì œ ìš”ì²­ (cmd: 8)]
                 * ì…ë ¥ë°›ì€ ë¬¸ìì—´(ì˜ˆ: "A_0001")ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ë§¤ì¹­ë˜ëŠ” ë‹¨ì¼ ê°ì²´ ì‚­ì œë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
                 * ì„œë²„ ì‘ë‹µ ìˆ˜ì‹  í›„ ë‹¤ì‹œ í˜„ì¬ í˜ì´ì§€ë¥¼ ê°±ì‹ í•˜ì—¬ ì‚­ì œ ê²°ê³¼ë¥¼ í™”ë©´ì— ë°˜ì˜í•©ë‹ˆë‹¤.
                 */
                if (send_and_receive(sock, cid, 8, action, res_msg, NULL) < 0) return -1;
                print_system_message(res_msg); 
                if (pause_screen(sock) < 0) return -1;
            }
        }
    }
    return 0; // ì •ìƒì ì¸ ì‚¬ìš©ì ì¢…ë£Œ ì‹œ ì œì–´ê¶Œ ë°˜í™˜
}

/**
 * @brief ì¬ê³  ê´€ë¦¬ ìš”ì•½ í™”ë©´(Dashboard) í‘œì‹œ ë° ì¼ê´„ ì²˜ë¦¬ ë¡œì§ ë‹´ë‹¹
 * [ì—­í•  1] ì„œë²„ë¡œë¶€í„° ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  í†µê³„(Summary)ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ì‹œê°í™”
 * [ì—­í•  2] ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥ë°›ì•„ í•˜ìœ„ ìƒì„¸ ì¡°íšŒ í•¨ìˆ˜(manage_inventory_detail)ë¡œ ì œì–´ê¶Œ ìœ„ì„
 * [ì—­í•  3] 'clear' ëª…ë ¹ì„ í†µí•œ ì „ì²´ íê¸° ë˜ëŠ” ì°½ê³  ì´ˆê¸°í™” ìˆ˜í–‰
 * * @param sock ì„œë²„ì™€ ì—°ê²°ëœ ì†Œì¼“ (I/O Multiplexing ê°ì‹œ ëŒ€ìƒ)
 * @param cid ë‹¨ë§ê¸° ê³ ìœ  ì‹ë³„ì
 * @param is_expired_mode ê´€ë¦¬ ëª¨ë“œ ì„¤ì • (0: ì¼ë°˜ ì¬ê³  ìš”ì•½, 1: ë§Œë£Œ ì¬ê³  ìš”ì•½)
 * @return int ì •ìƒ ì¢…ë£Œ ì‹œ 0, í†µì‹  ë‹¨ì ˆ(Server Down) ì‹œ -1 ì „ë‹¬
 */
static int manage_inventory_summary(int sock, uint32_t cid, int is_expired_mode) {
    char res_msg[MAX_PAYLOAD], action[50];
    
    // [ì„¤ì • ë¶„ê¸°] ëª¨ë“œì— ë”°ë¥¸ ì„œë²„ ëª…ë ¹ì–´(CMD) ë° ì‚¬ìš©ì ê°€ì´ë“œ ë§¤í•‘
    // sum_cmd: ìš”ì•½ ì •ë³´ ìš”ì²­ (7: ì „ì²´, 10: ë§Œë£Œ)
    // bulk_clear_cmd: ì¼ê´„ ì‚­ì œ ìš”ì²­ (16: ì°½ê³  ì´ˆê¸°í™”, 5: ë§Œë£Œ ì¼ê´„ íê¸°)
    int sum_cmd = is_expired_mode ? 10 : 7;
    int bulk_clear_cmd = is_expired_mode ? 5 : 16; 
    const char* clear_desc = is_expired_mode ? "ë§Œë£Œ ìƒí’ˆ ì¼ê´„ íê¸°" : "ì°½ê³  ì „ì²´ ë¹„ìš°ê¸°";

    while (1) {
        // [ë‹¨ê³„ 1: ë°ì´í„° ë™ê¸°í™”] ì„œë²„ë¡œë¶€í„° ìµœì‹  ì¬ê³  ìš”ì•½ ë³´ê³ ì„œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        // ë¹ˆ í˜ì´ë¡œë“œ("")ë¥¼ ì „ì†¡í•˜ë©°, ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ìºìŠ¤ì¼€ì´ë”©ì„ ìœ„í•´ -1ì„ ìƒìœ„ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
        if (send_and_receive(sock, cid, sum_cmd, "", res_msg, NULL) < 0) return -1;

        // [ë‹¨ê³„ 2: UI ë Œë”ë§] í™”ë©´ì„ ì§€ìš°ê³  ì„œë²„ì—ì„œ ê°€ê³µëœ ìš”ì•½ í…ìŠ¤íŠ¸ì™€ ëª…ë ¹ì–´ ê°€ì´ë“œë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
        clear_screen();
        printf("%s\n--------------------------------------\n", res_msg);
        printf(" ğŸ‘‰ [ìƒí’ˆëª…: ìƒì„¸ì¡°íšŒ] [clear: %s] [0: ë©”ì¸ìœ¼ë¡œ]\n", clear_desc);

        // [ë‹¨ê³„ 3: ì…ì¶œë ¥ ê°ì‹œ] ì‚¬ìš©ì ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì„œë²„ ì—°ê²° ìƒíƒœë¥¼ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
        // ì„œë²„ ì†Œì¼“ì—ì„œ í´ë¡œì¦ˆ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì…ë ¥ ëŒ€ê¸°ë¥¼ ì¤‘ë‹¨í•˜ê³  ì¦‰ì‹œ -1ì„ ë¦¬í„´í•©ë‹ˆë‹¤.
        if (get_string_input(sock, " >> ", action, sizeof(action)) < 0) return -1;

        // [ë‹¨ê³„ 4: ì…ë ¥ ëª…ë ¹ì–´ ë¶„ì„ ë° ì‹¤í–‰]
        
        // 4-1. ìƒìœ„ ê´€ë¦¬ì ë©”ì¸ ë©”ë‰´ë¡œ ë³µê·€
        if (strcmp(action, "0") == 0) {
            break; 
        } 
        
        // 4-2. ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë˜ëŠ” ì¼ê´„ íê¸° ì‹¤í–‰ (ê°€ì¥ ê°•ë ¥í•œ ë§ˆìŠ¤í„° ê¶Œí•œ ëª…ë ¹)
        else if (strcmp(action, "clear") == 0) {
            // ì„œë²„ì— ì¼ê´„ ì²˜ë¦¬ ìš”ì²­ ì „ì†¡ (cmd: 5 ë˜ëŠ” 16)
            if (send_and_receive(sock, cid, bulk_clear_cmd, "", res_msg, NULL) < 0) return -1;
            
            print_system_message(res_msg); // ì„œë²„ ì¸¡ ì²˜ë¦¬ ê²°ê³¼(ì‚­ì œëœ ê°œìˆ˜ ë“±) ì¶œë ¥
            if (pause_screen(sock) < 0) return -1; // ì‚¬ìš©ì í™•ì¸ ëŒ€ê¸°
        } 
        
        // 4-3. íŠ¹ì • ìƒí’ˆ ê²€ìƒ‰ (ìƒì„¸ ê´€ë¦¬ í™”ë©´ ì§„ì…)
        else if (strlen(action) > 0) { 
            // [ë°ì´í„° ì•ˆì „ì„± í™•ë³´] snprintfë¥¼ ì‚¬ìš©í•´ ì‚¬ìš©ì ì…ë ¥ê°’ì´ ë‚´ë¶€ ë²„í¼ë¥¼ ë„˜ì§€ ì•Šë„ë¡ 
            // ìµœëŒ€ 49ìì—ì„œ ìë¥´ê¸°(Truncation)ë¥¼ ìˆ˜í–‰í•˜ì—¬ ë©”ëª¨ë¦¬ ì˜¤ì—¼ì„ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
            char safe_name[50];
            snprintf(safe_name, sizeof(safe_name), "%.49s", action);
            
            // í•˜ìœ„ ìƒì„¸ ì¡°íšŒ í•¨ìˆ˜ë¡œ ì œì–´ê¶Œì„ ìœ„ì„í•©ë‹ˆë‹¤.
            // ìƒì„¸ í™”ë©´ì—ì„œ ì„œë²„ ëŠê¹€ì´ ë°œìƒí•  ê²½ìš°ì—ë„ ì—ëŸ¬(-1)ê°€ ì „íŒŒë˜ì–´ ì¦‰ì‹œ íƒˆì¶œí•©ë‹ˆë‹¤.
            if (manage_inventory_detail(sock, cid, is_expired_mode, safe_name) < 0) return -1; 
        }
    }
    return 0; // ì •ìƒì ì¸ ì‚¬ìš©ì ì¢…ë£Œ ì‹œ 0 ë°˜í™˜
}

/**
 * @brief ê´€ë¦¬ì ëª¨ë“œ(Admin Mode) ë©”ì¸ ë£¨í”„ ë° ì‘ì—… ë¶„ê¸° ì œì–´
 * [ì—­í•  1] ì…ê³ , ì¡°íšŒ, íê¸° ë“± ê´€ë¦¬ì ì „ìš© ë©”ë‰´ UIë¥¼ ì¶œë ¥í•˜ê³  ì‚¬ìš©ì ì„ íƒì„ ìˆ˜ì‹ 
 * [ì—­í•  2] ìˆ˜ë™ ì…ê³  ì‹œ ë°ì´í„° í¬ë§·íŒ… ë° ì…ë ¥ê°’ì— ëŒ€í•œ 1ì°¨ ìœ íš¨ì„± ê²€ì¦(ë³´ì•ˆ í•„í„°ë§)
 * [ì—­í•  3] ê° í•˜ìœ„ ê´€ë¦¬ í•¨ìˆ˜(Summary, Detail)ë¡œ ì œì–´ê¶Œì„ ìœ„ì„í•˜ì—¬ ê³„ì¸µí˜• êµ¬ì¡° ìœ ì§€
 * * @param sock ì„œë²„ì™€ ì—°ê²°ëœ ì†Œì¼“ (I/O Multiplexing ê°ì‹œ ëŒ€ìƒ)
 * @param cid ë‹¨ë§ê¸° ê³ ìœ  ì‹ë³„ ë²ˆí˜¸ (ë¡œê·¸ ê¸°ë¡ ë° ì„¸ì…˜ ì‹ë³„ìš©)
 * @return int ì •ìƒ ì¢…ë£Œ(0ë²ˆ ì„ íƒ) ì‹œ 0, í†µì‹  ì¤‘ ì„œë²„ ë‹¨ì ˆ ë°œìƒ ì‹œ -1 ë°˜í™˜
 */
int run_admin_mode(int sock, uint32_t cid) {
    char payload[256], res_msg[MAX_PAYLOAD]; 
    int choice;

    while (1) {
        // [ë‹¨ê³„ 1] ê´€ë¦¬ì ë©”ë‰´ UI ë Œë”ë§
        draw_admin_menu(cid); 
        
        // [ë‹¨ê³„ 2] ì‚¬ìš©ì ë©”ë‰´ ì„ íƒ ìˆ˜ì‹  ë° í†µì‹  ìƒíƒœ í™•ì¸
        // ì…ë ¥ ëŒ€ê¸° ì¤‘ ì„œë²„ê°€ ì¢…ë£Œë˜ë©´ get_int_inputì´ ì¦‰ì‹œ -1ì„ ë°˜í™˜í•˜ì—¬ ì¬ì—°ê²° ë¡œì§ìœ¼ë¡œ ìœ ë„í•¨
        if (get_int_input(sock, "ë©”ë‰´ ì„ íƒ >> ", &choice) < 0) return -1;

        // [ë‹¨ê³„ 3] ì¢…ë£Œ ì¡°ê±´ í™•ì¸: '0' ì…ë ¥ ì‹œ ê´€ë¦¬ì ëª¨ë“œ ë£¨í”„ íƒˆì¶œ ë° ë©”ì¸ ë©”ë‰´ ë³µê·€
        if (choice == 0) break; 

        // [ë‹¨ê³„ 4] ë©”ë‰´ ì„ íƒì— ë”°ë¥¸ ê¸°ëŠ¥ ë¶„ê¸° ì²˜ë¦¬ (Switch-Case)
        switch (choice) {
            case 1: { 
                // [ê¸°ëŠ¥ 1] ìˆ˜ë™ ìƒí’ˆ ë‹¨ì¼ ì…ê³  ì²˜ë¦¬
                char id[20], name[50]; 
                int h;

                // [ë°ì´í„° ì…ë ¥] ê° í•­ëª©ë³„ ì…ë ¥ì„ ìˆœì°¨ì ìœ¼ë¡œ ìˆ˜ì‹  (ì…ë ¥ ì¤‘ ì„œë²„ ë‹¨ì ˆ ê°ì‹œ)
                if (get_string_input(sock, "ìƒí’ˆ ID: ", id, sizeof(id)) < 0) return -1;
                if (get_string_input(sock, "ìƒí’ˆëª…: ", name, sizeof(name)) < 0) return -1;
                if (get_int_input(sock, "ìœ íš¨ì‹œê°„(ì‹œê°„): ", &h) < 0) return -1;
                
                // [ë³´ì•ˆ ë° ìœ íš¨ì„± ê²€ì¦] ìœ íš¨ì‹œê°„ì´ ìŒìˆ˜ì´ê±°ë‚˜ 0ì¼ ê²½ìš° ë…¼ë¦¬ì  ì˜¤ë¥˜ ë°©ì§€
                if (h <= 0) {
                    print_system_message("[ì˜¤ë¥˜] ìœ íš¨ì‹œê°„ì€ 1ì‹œê°„ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    if (pause_screen(sock) < 0) return -1;
                    break; // í•´ë‹¹ switchë¬¸ íƒˆì¶œ í›„ ë£¨í”„ ì¬ì‹œì‘
                }

                /* [ë°ì´í„° íŒ¨í‚¤ì§•] 
                 * êµ¬ë¶„ì('|')ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ê°€ íŒŒì‹±í•˜ê¸° ì‰¬ìš´ í”„ë¡œí† ì½œ í˜•ì‹ìœ¼ë¡œ ê²°í•©
                 * %.19s, %.49së¥¼ ì‚¬ìš©í•˜ì—¬ ê³ ì •ëœ ë°°ì—´ í¬ê¸°ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì•ˆì „í•˜ê²Œ ê¸°ë¡
                 */
                snprintf(payload, sizeof(payload), "%.19s|%.49s|%d", id, name, h);
                
                // [ì„œë²„ ìš”ì²­: cmd 1] ì„œë²„ë¡œ ë‹¨ì¼ ì…ê³  íŒ¨í‚· ì „ì†¡ ë° ê²°ê³¼ ìˆ˜ì‹ 
                if (send_and_receive(sock, cid, 1, payload, res_msg, NULL) < 0) return -1;
                
                print_system_message(res_msg); // ì„œë²„ ì²˜ë¦¬ ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨ ì‚¬ìœ ) ì¶œë ¥
                if (pause_screen(sock) < 0) return -1;
                break;
            }
            case 2: { 
                // [ê¸°ëŠ¥ 2] ëŒ€ëŸ‰ ëœë¤ ìƒí’ˆ ì…ê³  ì²˜ë¦¬ (í…ŒìŠ¤íŠ¸ ë° ëŒ€ëŸ‰ ì¬ê³  í™•ë³´ìš©)
                int q;
                if (get_int_input(sock, "ì…ê³  ìˆ˜ëŸ‰: ", &q) < 0) return -1;

                // [ë³´ì•ˆ ë° ìœ íš¨ì„± ê²€ì¦] ëŒ€ëŸ‰ ì…ê³  ìˆ˜ëŸ‰ì˜ ìœ íš¨ì„± í™•ì¸
                if (q <= 0) {
                    print_system_message("[ì˜¤ë¥˜] ì…ê³  ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    if (pause_screen(sock) < 0) return -1;
                    break;
                }

                // [ì„œë²„ ìš”ì²­: cmd 2] ì •ìˆ˜í˜• ìˆ˜ëŸ‰ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ í˜ì´ë¡œë“œ êµ¬ì„±
                snprintf(payload, sizeof(payload), "%d", q);
                if (send_and_receive(sock, cid, 2, payload, res_msg, NULL) < 0) return -1;
                
                print_system_message(res_msg); 
                if (pause_screen(sock) < 0) return -1;
                break;
            }
            case 3: 
                // [ê¸°ëŠ¥ 3] ì „ì²´ ì¬ê³  ìš”ì•½ ë° ë“œë¦´ë‹¤ìš´ ê´€ë¦¬ í™”ë©´ ì§„ì… (is_expired_mode = 0)
                if (manage_inventory_summary(sock, cid, 0) < 0) return -1; 
                break;
            case 4: 
                // [ê¸°ëŠ¥ 4] ë§Œë£Œ ì¬ê³  ìš”ì•½ ë° ë“œë¦´ë‹¤ìš´ ê´€ë¦¬ í™”ë©´ ì§„ì… (is_expired_mode = 1)
                if (manage_inventory_summary(sock, cid, 1) < 0) return -1; 
                break;
            default: 
                // [ì˜ˆì™¸ ì²˜ë¦¬] ë©”ë‰´ ë²ˆí˜¸ ì´ì™¸ì˜ ì˜ëª»ëœ ê°’ ì…ë ¥ ì‹œ ì•ˆë‚´
                print_system_message("[ì˜¤ë¥˜] ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤."); 
                if (pause_screen(sock) < 0) return -1; 
                break;
        }
    }
    return 0; // ë©”ì¸ ë£¨í”„ ì •ìƒ ì¢…ë£Œ ì‹œ ì œì–´ê¶Œ ë°˜í™˜
}